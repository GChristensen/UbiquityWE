var noun_type_lang_google = CmdUtils.NounType("language", {
    Afrikaans: "af",
    Albanian: "sq",
    Arabic: "ar",
    Armenian: "hy",
    Azerbaijani: "az",
    Basque: "eu",
    Belarusian: "be",
    Bulgarian: "bg",
    Catalan: "ca",
    "Chinese Simplified": "zh-CN",
    "Chinese Traditional": "zh-TW",
    Croatian: "hr",
    Czech: "cs",
    Danish: "da",
    Dutch: "nl",
    English: "en",
    Estonian: "et",
    Filipino: "tl",
    Finnish: "fi",
    French: "fr",
    Galician: "gl",
    Georgian: "ka",
    German: "de",
    Greek: "el",
    Hebrew: "iw",
    Hindi: "hi",
    Hungarian: "hu",
    Icelandic: "is",
    Indonesian: "id",
    Irish: "ga",
    Italian: "it",
    Japanese: "ja",
    Korean: "ko",
    Latin: "la",
    Latvian: "lv",
    Lithuanian: "lt",
    Macedonian: "mk",
    Malay: "ms",
    Maltese: "mt",
    Norwegian: "no",
    Persian: "fa",
    Polish: "pl",
    Portuguese: "pt",
    Romanian: "ro",
    Russian: "ru",
    Serbian: "sr",
    Slovak: "sk",
    Slovenian: "sl",
    Spanish: "es",
    Swahili: "sw",
    Swedish: "sv",
    Thai: "th",
    Turkish: "tr",
    Ukrainian: "uk",
    Urdu: "ur",
    Vietnamese: "vi",
    Welsh: "cy",
    Yiddish: "yi",
});

var noun_type_lang_wikipedia = CmdUtils.NounType("language", {
    English: "en",
    German: "de",
    French: "fr",
    Polish: "pl",
    Japanese: "ja",
    Italian: "it",
    Dutch: "nl",
    Portuguese: "pt",
    Spanish: "es",
    Russian: "ru",
    Swedish: "sv",
    Chinese: "zh",
    "Norwegian (Bokmal)": "no",
    Finnish: "fi",
    Catalan: "ca",
    Ukrainian: "uk",
    Turkish: "tr",
    Czech: "cs",
    Hungarian: "hu",
    Romanian: "ro",
    Volapuk: "vo",
    Esperanto: "eo",
    Danish: "da",
    Slovak: "sk",
    Indonesian: "id",
    Arabic: "ar",
    Korean: "ko",
    Hebrew: "he",
    Lithuanian: "lt",
    Vietnamese: "vi",
    Slovenian: "sl",
    Serbian: "sr",
    Bulgarian: "bg",
    Estonian: "et",
    Persian: "fa",
    Croatian: "hr",
    "Simple English": "simple",
    "Newar / Nepal Bhasa": "new",
    Haitian: "ht",
    "Norwegian (Nynorsk)": "nn",
    Galician: "gl",
    Thai: "th",
    Telugu: "te",
    Greek: "el",
    Malay: "ms",
    Basque: "eu",
    Cebuano: "ceb",
    Hindi: "hi",
    Macedonian: "mk",
    Georgian: "ka",
    Latin: "la",
    Bosnian: "bs",
    Luxembourgish: "lb",
    Breton: "br",
    Icelandic: "is",
    "Bishnupriya Manipuri": "bpy",
    Marathi: "mr",
    Albanian: "sq",
    Welsh: "cy",
    Azeri: "az",
    "Serbo-Croatian": "sh",
    Tagalog: "tl",
    Latvian: "lv",
    Piedmontese: "pms",
    Bengali: "bn",
    "Belarusian (Tarashkevitsa)": "be-x-old",
    Javanese: "jv",
    Tamil: "ta",
    Occitan: "oc",
    Ido: "io",
    Belarusian: "be",
    Aragonese: "an",
    "Low Saxon": "nds",
    Sundanese: "su",
    Sicilian: "scn",
    Neapolitan: "nap",
    Kurdish: "ku",
    Asturian: "ast",
    Afrikaans: "af",
    "West Frisian": "fy",
    Swahili: "sw",
    Walloon: "wa",
    Cantonese: "zh-yue",
    Samogitian: "bat-smg",
    Quechua: "qu",
    Urdu: "ur",
    Chuvash: "cv",
    Ripuarian: "ksh",
    Malayalam: "ml",
    Tajik: "tg",
    Irish: "ga",
    Venetian: "vec",
    Tarantino: "roa-tara",
    "Waray-Waray": "war",
    Uzbek: "uz",
    "Scottish Gaelic": "gd",
    Kapampangan: "pam",
    Kannada: "kn",
    Maori: "mi",
    Yiddish: "yi",
    Yoruba: "yo",
    Gujarati: "gu",
    Nahuatl: "nah",
    Lombard: "lmo",
    Corsican: "co",
    Gilaki: "glk",
    "Upper Sorbian": "hsb",
    "Min Nan": "zh-min-nan",
    Aromanian: "roa-rup",
    Alemannic: "als",
    Interlingua: "ia",
    Limburgian: "li",
    Armenian: "hy",
    Sakha: "sah",
    Kazakh: "kk",
    Tatar: "tt",
    Gan: "gan",
    Sanskrit: "sa",
    Turkmen: "tk",
    Wu: "wuu",
    "Dutch Low Saxon": "nds-nl",
    Faroese: "fo",
    "West Flemish": "vls",
    Norman: "nrm",
    Ossetian: "os",
    Voro: "fiu-vro",
    Amharic: "am",
    Romansh: "rm",
    Banyumasan: "map-bms",
    Pangasinan: "pag",
    Divehi: "dv",
    Mongolian: "mn",
    "Egyptian Arabic": "arz",
    "Northern Sami": "se",
    Zazaki: "diq",
    Nepali: "ne",
    Friulian: "fur",
    Manx: "gv",
    Scots: "sco",
    Ligurian: "lij",
    Novial: "nov",
    Bavarian: "bar",
    Bihari: "bh",
    Maltese: "mt",
    Ilokano: "ilo",
    Pali: "pi",
    "Classical Chinese": "zh-classical",
    Khmer: "km",
    "Franco-Provencal/Arpitan": "frp",
    Mazandarani: "mzn",
    Kashubian: "csb",
    Ladino: "lad",
    "Pennsylvania German": "pdc",
    Uyghur: "ug",
    Cornish: "kw",
    Sinhalese: "si",
    "Anglo-Saxon": "ang",
    Hawaiian: "haw",
    Tongan: "to",
    Sardinian: "sc",
    "Central_Bicolano": "bcl",
    Komi: "kv",
    Punjabi: "pa",
    Pashto: "ps",
    Silesian: "szl",
    Interlingue: "ie",
    Malagasy: "mg",
    Guarani: "gn",
    Lingala: "ln",
    Burmese: "my",
    "Fiji Hindi": "hif",
}, "^_");

for (let ntl of [noun_type_lang_google, noun_type_lang_wikipedia]) {
    ntl._code2name = ntl._list.reduce(function (o, s) {
        o[s.data] = s.text;
        return o;
    }, {});
    ntl.getLangName = function getLangName(langCode) {
        return this._code2name[langCode]
    };
    ntl.noSelection = true;
}

{
    noun_type_lang_wikipedia.default.push(
        CmdUtils.makeSugg("English", null, "en"));
}

(function () {

    const MS_TRANSLATOR_LIMIT = 1e4
        , MS_LANGS = {}
        , MS_LANGS_REV =
        {
            ar: "Arabic"
            , bg: "Bulgarian"
            , ca: "Catalan"
            , cs: "Czech"
            , da: "Danish"
            , nl: "Dutch"
            , en: "English"
            , et: "Estonian"
            , fi: "Finnish"
            , fr: "French"
            , de: "German"
            , el: "Greek"
            , he: "Hebrew"
            , hi: "Hindi"
            , hu: "Hungarian"
            , id: "Indonesian"
            , it: "Italian"
            , ja: "Japanese"
            , ko: "Korean"
            , lv: "Latvian"
            , lt: "Lithuanian"
            , no: "Norwegian"
            , pl: "Polish"
            , pt: "Portuguese"
            , ro: "Romanian"
            , ru: "Russian"
            , sk: "Slovak"
            , sl: "Slovenian"
            , es: "Spanish"
            , sv: "Swedish"
            , th: "Thai"
            , tr: "Turkish"
            , uk: "Ukrainian"
            , vi: "Vietnamese"
            , "zh-CN": "Chinese Simplified"
            , "zh-TW": "Chinese Traditional"
        }
    for (let [code, name] of Object.entries(MS_LANGS_REV)) MS_LANGS[name] = code;

    function translate(target, from, to, back) {
        if (!to) return void
            msTranslator("Detect", {text: target.text}, function detected(code) {
                translate(target, from, "en", back)
            })
        var {html} = target
        // bitbucket#29: The API doesn't like apostrophes HTML-escaped.
        ~html.indexOf('<') || (html = html.replace(/&#39;/g, "'"))
        msTranslator("Translate", {
            contentType: "text/html", text: html, from: from, to: to,
        }, back)
    }

    function msTranslator(method, params, back) {
        params.appId = "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" + new Date % 10
        $.ajax({
            url: "http://api.microsofttranslator.com/V2/Ajax.svc/" + method,
            data: params,
            success: function mst_ok(json) {
                back(JSON.parse(json))
            },
            error: function mst_ng() {
                displayMessage({title: "Microsoft Translator", text: "(>_<)"})
            },
        })
    }

    CmdUtils.CreateCommand({
        name: "translate",
        _namespace: "Translation",
        description: "Translates from one language to another.",
        icon: "res/translate_bing.ico",
        arguments: ((noun) => ({
            object: noun_arb_text,
            source: noun,
            goal: noun,
        }))(CmdUtils.NounType("language", MS_LANGS)),
        builtIn: true,
        timeout: 1000,
        help: '\
    You can specify the language to translate to,\
    and the language to translate from.\
    For example, try issuing "translate mother from English to Spanish".\
    If you leave out the languages, it will try to guess what you want.\
    It works on selected text in any web page,\
    but there&#39;s a limit (a couple of paragraphs)\
    to how much it can translate a selection at once.\
    If you want to translate a lot of text, leave out the input and\
    it will load\
    <a href="http://www.microsofttranslator.com">Bing Translator</a> toolbar.\
  ',
        author: "satyr",
        execute: function translate_execute({object, goal, source}) {
            let from = "en", to = "en";

            if (source && source.data)
                from = source.data;

            if (goal && goal.data)
                to = goal.data;

            if (object.text && object.text.length <= MS_TRANSLATOR_LIMIT)
                translate(object, from, to, CmdUtils.setSelection.bind(CmdUtils))
            else
                CmdUtils.injectJs(
                    "http://labs.microsofttranslator.com/bookmarklet/default.aspx?f=js" +
                    "&from=" + from  +
                    "&to=" + to)
            CmdUtils.closePopup();
        },
        preview: function translate_preview(pblock, {object, goal, source}) {
            let limitExceeded = object.text && object.text.length > MS_TRANSLATOR_LIMIT;

            if (!object.text || limitExceeded) {
                let ph = _(`\
                      Loads <a href="http://www.microsofttranslator.com">Bing Translator</a>\
                      toolbar.\
                    `);
                if (limitExceeded)
                    ph += '<p><em class="error">' +
                        _("The text you selected exceeds the API limit.") +
                        '</em>';
                pblock.innerHTML = ph;
                return
            }

            let phtml = _("Translates the selected text: ");
            pblock.innerHTML = phtml + " ...";

            let from = "en", to = "en";

            if (source && source.data)
                from = source.data;

            if (goal && goal.data)
                to = goal.data;

            translate(
                object, from, to,
                CmdUtils.previewCallback(pblock, function show(html) {
                    pblock.innerHTML = phtml + "<br><br>" + html
                })
            )
        }
    });

    function defaultLanguage(code2name, exclude) {
        for (let pref of [exclude ? PREF_LANG_ALT : PREF_LANG_DEFAULT,
            "intl.accept_languages",
            "general.useragent.locale"])
            for (let code of Utils.prefs.get(pref, "").split(",")) {
                if (!(code = code.trim())) continue
                code = (/^(..-)(..)$/i.test(code)
                    ? RegExp.$1.toLowerCase() + RegExp.$2.toUpperCase()
                    : code.slice(0, 2).toLowerCase())
                if (code === exclude) continue
                let name = code2name[code]
                if (name) return {name: name, code: code}
            }
        var fallback = exclude === "en" ? "ja" : "en"
        return {name: code2name[fallback], code: fallback}
    }


    CmdUtils.CreateCommand({
        names: ["translate-page"],
        _namespace: "Translation",
        description: '\
    Translates a whole page to the specified language using\
    <a href="http://translate.google.com">Google Translate</a>.\
  ',
        icon: "res/translate_google.ico",
        author: "satyr",
        builtIn: true,
        arguments: {
            object: noun_arb_text,
            goal: noun_type_lang_google,
        },
        execute: function gtranslate_execute({object, goal}) {
            Utils.openUrlInBrowser(
                "http://translate.google.com/translate" +
                Utils.paramsToString({
                    u: object.text,
                    tl: goal.data || "en",
                }));
            CmdUtils.closePopup();
        },
        preview: function gtranslate_preview(pb, {object, goal}) {
            pb.innerHTML =
                _("Translates <code>page</code> to <strong>selected language</strong>.", {
                    url: Utils.escapeHtml(object.text),
                    language: goal.text || "English",
                })
        },
    })


})();